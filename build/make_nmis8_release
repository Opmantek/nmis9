#!/bin/sh
# this version is an update of the older release maker from the opmantek repo

if [ -z "$1" ] || [ ! -d "build" ]; then

		cat >&1 <<EOF
Usage: $0 <nmisversion> [rtag1 rtag2..]
e.g. $0 8.5.10G
or $0 8.5.12G HEAD \`git tag\`

the release is made from the CURRENT branch;
must be called from source dir.

rtags are needed for capture_model_sigs/capture_table_sigs,
upgrade_models/upgrade_tables;
if not present ALL nmis release tags plus HEAD are used!

EOF
		exit 1
else
		VERSION=$1
fi
shift
TAGS="$@"

TEMPDIR=`mktemp -d`
TARGETDIR=nmis$VERSION
RELEASEDIR=/usr/local/release

# which branch are we in?
BRANCH=`git rev-parse --abbrev-ref HEAD`
echo "Building release from branch $BRANCH"

mkdir -p $TEMPDIR/$TARGETDIR
cd $TEMPDIR
git clone -b $BRANCH gitolite@community:nmis $TARGETDIR

if [ -z "$TAGS" ]; then
		TAGS="HEAD `cd $TARGETDIR; git tag`"
fi

# before we remove build files do get the model signatures
echo "Capturing model sigs, for releases $TAGS"
( cd $TARGETDIR; ./build/capture_model_sigs ./admin/upgrade_models.pl $TAGS; );

echo "Capturing table sigs, for releases $TAGS"
( cd $TARGETDIR; ./build/capture_table_sigs ./admin/upgrade_tables.pl $TAGS; );


# create the dirs that are empty and therefore not in git
for i in conf database models htdocs/reports logs/json; do
		mkdir -p $TARGETDIR/$i;
done

# cleanup and distinction free/non-free code
# do NOT ship the development plugins at all, nor the build dir
rm -rf $TARGETDIR/install/plugins-dev $TARGETDIR/build $TARGETDIR/private

# Move the code for licensed modules out of free code
NONFREE=$TARGETDIR-extra
for i in admin install bin lib lib/NMIS cgi-bin; do
		mkdir -p $NONFREE/$i
done

mv $TARGETDIR/install-cisco-models.sh $TARGETDIR/test $TARGETDIR/dev $TARGETDIR/models-dev $TARGETDIR/models-minimal $TARGETDIR/models-archive $NONFREE
# note: opha-related files are now in opmojo, in install/nmis/!

mv $TARGETDIR/cgi-bin/connect.pl $TARGETDIR/cgi-bin/cplancgi.pl $TARGETDIR/cgi-bin/debug-master.pl \
	 $TARGETDIR/cgi-bin/tenants.pl $TARGETDIR/cgi-bin/opsla.pl $NONFREE/cgi-bin

mv $TARGETDIR/bin/opslad.pl $TARGETDIR/bin/cplan.pl $NONFREE/bin
mv $TARGETDIR/lib/NMIS/IPSLA.pm $TARGETDIR/lib/NMIS/Integration.pm $NONFREE/lib/NMIS/
mv $TARGETDIR/admin/opsla* $TARGETDIR/admin/find_ipsla_nodes.pl $TARGETDIR/admin/oss_export_* $NONFREE/admin

# must ditch the git files before making self-extracting installer
rm -rf $TARGETDIR/.git $TARGETDIR/.gitignore

# create the tarballs we want
tar --exclude .git --exclude .gitignore -czvf $RELEASEDIR/nmis$VERSION.tar.gz ./$TARGETDIR
tar --exclude .git --exclude .gitignore -czvf $RELEASEDIR/nmis$VERSION-nonfree.tar.gz ./$NONFREE

# what to run? install.pl for older versions, pre-install.sh for newest
RUNTHIS=./install.pl
[ -f $TARGETDIR/pre-install.sh ] && RUNTHIS=./pre-install.sh

# now also make the self-extracting installer file, but only for main nmis
makeself $TARGETDIR $RELEASEDIR/nmis$VERSION.run "NMIS Version $VERSION" $RUNTHIS

echo "Release $VERSION ready in $RELEASEDIR/nmis$VERSION.tar.gz and $RELEASEDIR/nmis$VERSION.run"
echo "extra non-OSS files are in nmis$VERSION-nonfreetar.gz."

cd /

rm -rf $TEMPDIR
